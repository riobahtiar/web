---
import BlogIndex from "../../../layouts/BlogIndex.astro";
import { getCollection } from "astro:content";

// Get page number from URL params (SSR mode)
const pageParam = Astro.params.page;
const currentPage = pageParam ? parseInt(pageParam) : 1;

const posts = await getCollection("blog-id");

// Sort posts by date
const sortedPosts = posts.sort(
  (a, b) => b.data.created_at.valueOf() - a.data.created_at.valueOf(),
);

// Get categories and count
const categories = [...new Set(posts.map((post) => post.data.category))].map(
  (category) => ({
    name: category,
    count: posts.filter((post) => post.data.category === category).length,
  }),
);

// Manual pagination
const pageSize = 10;
const totalPages = Math.ceil(sortedPosts.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const paginatedPosts = sortedPosts.slice(startIndex, endIndex);

// Build pagination URLs
const prevUrl = currentPage > 1 ? `/id/blog/${currentPage - 1}` : undefined;
const nextUrl = currentPage < totalPages ? `/id/blog/${currentPage + 1}` : undefined;
const title = "Blog";
const description =
  "Jelajahi pemikiran, pengalaman, dan wawasan saya tentang pengembangan perangkat lunak, teknologi, dan lainnya.";
---

<BlogIndex
  title={title}
  description={description}
  lang="id"
  posts={paginatedPosts}
  categories={categories}
  pagination={{
    currentPage: currentPage,
    totalPages: totalPages,
    url: {
      prev: prevUrl,
      next: nextUrl,
    },
  }}
/>
