---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import { formatDate } from "../../../utils/date";
import { getReadingTimeI18n } from "../../../utils/readingTime";

// Get tag from URL (SSR mode)
const { tag } = Astro.params;

if (!tag) {
  return Astro.redirect("/404");
}

// Get all English blog posts with this tag
const allPosts = await getCollection("blog-en");
const filteredPosts = allPosts
  .filter((post) => post.data.tags.includes(tag))
  .sort((a, b) => b.data.created_at.getTime() - a.data.created_at.getTime());

if (filteredPosts.length === 0) {
  return Astro.redirect("/blog");
}

// Calculate reading time for each post
const postsWithReadingTime = filteredPosts.map((post) => ({
  ...post,
  readingTime: getReadingTimeI18n(post.body, "en"),
}));

const pageTitle = `Posts tagged "${tag}"`;
const pageDescription = `Browse all blog posts tagged with "${tag}". ${filteredPosts.length} ${filteredPosts.length === 1 ? "post" : "posts"} found.`;
---

<Layout title={pageTitle} description={pageDescription} lang="en">
  <main class="container mx-auto max-w-6xl px-4 py-12">
    <!-- Page Header -->
    <header class="mb-12">
      <nav class="breadcrumbs mb-4 text-sm">
        <ul>
          <li><a href="/blog">Blog</a></li>
          <li>Tag: {tag}</li>
        </ul>
      </nav>
      <h1 class="mb-4 text-4xl font-bold">
        Posts tagged <span class="text-primary">#{tag}</span>
      </h1>
      <p class="text-base-content/70">
        {filteredPosts.length}
        {filteredPosts.length === 1 ? "post" : "posts"} found
      </p>
    </header>

    <!-- Posts Grid -->
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {
        postsWithReadingTime.map((post) => {
          const slug = post.slug.startsWith(post.data.category + "/")
            ? post.slug.substring(post.data.category.length + 1)
            : post.slug;

          return (
            <article class="card bg-base-200 shadow-lg transition-shadow hover:shadow-xl">
              {post.data.image && (
                <figure class="aspect-video">
                  <img
                    src={post.data.image}
                    alt={post.data.title}
                    width="400"
                    height="225"
                    class="h-full w-full object-cover"
                  />
                </figure>
              )}
              <div class="card-body">
                <div class="text-base-content/60 mb-2 flex items-center gap-2 text-sm">
                  <a
                    href={`/blog/${post.data.category}`}
                    class="badge badge-primary badge-sm"
                  >
                    {post.data.category}
                  </a>
                  <span>•</span>
                  <time datetime={post.data.created_at.toISOString()}>
                    {formatDate(post.data.created_at, "en")}
                  </time>
                  {post.readingTime && (
                    <>
                      <span>•</span>
                      <span>{post.readingTime}</span>
                    </>
                  )}
                </div>

                <h2 class="card-title mb-2 text-xl">
                  <a
                    href={`/blog/${post.data.category}/${slug}`}
                    class="hover:text-primary transition-colors"
                  >
                    {post.data.title}
                  </a>
                </h2>

                <p class="text-base-content/80 mb-4 line-clamp-3 text-sm">
                  {post.data.description}
                </p>

                <div class="card-actions items-center justify-between">
                  <div class="flex flex-wrap gap-1">
                    {post.data.tags.slice(0, 3).map((t) => (
                      <a
                        href={`/blog/tag/${t}`}
                        class={`badge badge-sm ${t === tag ? "badge-primary" : "badge-ghost"}`}
                      >
                        #{t}
                      </a>
                    ))}
                  </div>
                  <a
                    href={`/blog/${post.data.category}/${slug}`}
                    class="btn btn-sm btn-ghost"
                  >
                    Read More →
                  </a>
                </div>
              </div>
            </article>
          );
        })
      }
    </div>
  </main>
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
